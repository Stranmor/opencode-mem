<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OpenCode Memory Viewer</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{--bg:#0d0d14;--surface:#151520;--surface-2:#1a1a28;--border:#252535;--accent:#3b82f6;--accent-dim:#1e40af;--text:#e4e4eb;--text-dim:#8888a0;--success:#22c55e;--warning:#eab308;--error:#ef4444}
body{font-family:'SF Mono',Monaco,'Cascadia Code',monospace;background:var(--bg);color:var(--text);min-height:100vh;line-height:1.5}
.container{max-width:1200px;margin:0 auto;padding:1rem}
header{display:flex;align-items:center;justify-content:space-between;padding:1rem 0;border-bottom:1px solid var(--border);margin-bottom:1.5rem}
h1{font-size:1.25rem;font-weight:600;background:linear-gradient(135deg,var(--accent),#8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.status{display:flex;align-items:center;gap:.5rem;font-size:.75rem;color:var(--text-dim)}
.status-dot{width:8px;height:8px;border-radius:50%;background:var(--error);animation:pulse 2s infinite}
.status-dot.connected{background:var(--success)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.search-bar{display:flex;gap:.75rem;margin-bottom:1.5rem}
.search-input{flex:1;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:.75rem 1rem;color:var(--text);font-size:.875rem;font-family:inherit;transition:border-color .2s,box-shadow .2s}
.search-input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,130,246,.15)}
.search-input::placeholder{color:var(--text-dim)}
.btn{background:var(--accent);color:#fff;border:none;border-radius:8px;padding:.75rem 1.25rem;font-size:.875rem;font-weight:500;cursor:pointer;transition:background .2s,transform .1s}
.btn:hover{background:var(--accent-dim)}
.btn:active{transform:scale(.98)}
.btn-secondary{background:var(--surface-2);border:1px solid var(--border)}
.btn-secondary:hover{background:var(--surface);border-color:var(--accent)}
.tabs{display:flex;gap:.5rem;margin-bottom:1.5rem}
.tab{padding:.5rem 1rem;background:transparent;border:1px solid transparent;border-radius:6px;color:var(--text-dim);font-size:.8rem;cursor:pointer;transition:all .2s}
.tab:hover{color:var(--text);background:var(--surface)}
.tab.active{background:var(--surface-2);border-color:var(--border);color:var(--text)}
.observations{display:flex;flex-direction:column;gap:1rem}
.card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:1.25rem;transition:border-color .2s,transform .2s}
.card:hover{border-color:var(--accent-dim);transform:translateY(-2px)}
.card.new{animation:slideIn .3s ease-out}
@keyframes slideIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
.card-header{display:flex;align-items:flex-start;justify-content:space-between;gap:1rem;margin-bottom:.75rem}
.card-title{font-size:.95rem;font-weight:600;color:var(--text)}
.card-meta{display:flex;align-items:center;gap:.75rem;font-size:.7rem;color:var(--text-dim)}
.badge{display:inline-flex;align-items:center;padding:.25rem .5rem;border-radius:4px;font-size:.65rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px}
.badge-bugfix{background:rgba(239,68,68,.15);color:#f87171}
.badge-feature{background:rgba(34,197,94,.15);color:#4ade80}
.badge-refactor{background:rgba(168,85,247,.15);color:#c084fc}
.badge-change{background:rgba(59,130,246,.15);color:#60a5fa}
.badge-discovery{background:rgba(234,179,8,.15);color:#facc15}
.badge-decision{background:rgba(236,72,153,.15);color:#f472b6}
.card-narrative{color:var(--text-dim);font-size:.85rem;line-height:1.6;margin-bottom:.75rem}
.card-facts{display:flex;flex-wrap:wrap;gap:.5rem}
.fact{background:var(--surface-2);padding:.25rem .5rem;border-radius:4px;font-size:.7rem;color:var(--text-dim)}
.empty-state{text-align:center;padding:4rem 2rem;color:var(--text-dim)}
.empty-state svg{width:64px;height:64px;margin-bottom:1rem;opacity:.3}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem;margin-bottom:1.5rem}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:1rem;text-align:center}
.stat-value{font-size:1.5rem;font-weight:700;color:var(--accent)}
.stat-label{font-size:.7rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:.5px}
.timeline-date{font-size:.75rem;color:var(--text-dim);padding:.5rem 0;border-bottom:1px solid var(--border);margin-bottom:1rem}
footer{text-align:center;padding:2rem 0;color:var(--text-dim);font-size:.7rem;border-top:1px solid var(--border);margin-top:2rem}
</style>
</head>
<body>
<div class="container">
<header>
<h1>◈ OpenCode Memory</h1>
<div class="status">
<span class="status-dot" id="statusDot"></span>
<span id="statusText">Connecting...</span>
</div>
</header>
<div class="stats" id="stats"></div>
<div class="search-bar">
<input type="text" class="search-input" id="searchInput" placeholder="Search observations... (press Enter)">
<button class="btn" id="searchBtn">Search</button>
<button class="btn btn-secondary" id="clearBtn">Clear</button>
</div>
<div class="tabs">
<button class="tab active" data-view="live">Live Stream</button>
<button class="tab" data-view="timeline">Timeline</button>
<button class="tab" data-view="search">Search Results</button>
</div>
<div class="observations" id="observations">
<div class="empty-state">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
<path d="M12 6v6l4 2M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/>
</svg>
<p>Waiting for observations...</p>
</div>
</div>
<footer>opencode-mem v0.1.0 · Rust port of claude-mem</footer>
</div>
<script>
(function(){
const $=s=>document.querySelector(s);
const $$=s=>document.querySelectorAll(s);
const observations=[];
let currentView='live';
let searchResults=[];
let eventSource=null;

function formatTime(ts){
const d=new Date(ts);
const now=new Date();
const diff=now-d;
if(diff<60000)return'just now';
if(diff<3600000)return Math.floor(diff/60000)+'m ago';
if(diff<86400000)return Math.floor(diff/3600000)+'h ago';
return d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
}

function badgeClass(type){
return'badge badge-'+(type||'change');
}

function renderCard(obs,isNew=false){
const facts=obs.facts||[];
const factsHtml=facts.slice(0,3).map(f=>`<span class="fact">${escapeHtml(f)}</span>`).join('');
return`
<div class="card${isNew?' new':''}">
<div class="card-header">
<span class="card-title">${escapeHtml(obs.title||'Untitled')}</span>
<div class="card-meta">
<span class="${badgeClass(obs.observation_type)}">${obs.observation_type||'change'}</span>
<span>${formatTime(obs.created_at)}</span>
</div>
</div>
${obs.narrative?`<p class="card-narrative">${escapeHtml(obs.narrative)}</p>`:''}
${factsHtml?`<div class="card-facts">${factsHtml}</div>`:''}
</div>`;
}

function escapeHtml(s){
if(!s)return'';
return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function renderObservations(list,isNew=false){
const container=$('#observations');
if(!list.length){
container.innerHTML=`<div class="empty-state">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
<path d="M12 6v6l4 2M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/>
</svg>
<p>${currentView==='search'?'No results found':'Waiting for observations...'}</p>
</div>`;
return;
}
container.innerHTML=list.map((o,i)=>renderCard(o,isNew&&i===0)).join('');
}

function updateStats(){
fetch('/stats').then(r=>r.json()).then(data=>{
$('#stats').innerHTML=`
<div class="stat-card"><div class="stat-value">${data.total_observations||0}</div><div class="stat-label">Observations</div></div>
<div class="stat-card"><div class="stat-value">${data.total_sessions||0}</div><div class="stat-label">Sessions</div></div>
<div class="stat-card"><div class="stat-value">${data.total_projects||0}</div><div class="stat-label">Projects</div></div>
`;
}).catch(()=>{});
}

function loadRecent(){
fetch('/recent?limit=50').then(r=>r.json()).then(data=>{
data.forEach(r=>{
if(!observations.find(o=>o.id===r.id)){
observations.unshift({id:r.id,title:r.title,subtitle:r.subtitle,observation_type:r.observation_type,created_at:new Date().toISOString()});
}
});
if(currentView==='live')renderObservations(observations);
}).catch(()=>{});
}

function search(q){
if(!q.trim()){
currentView='live';
$$('.tab').forEach(t=>t.classList.toggle('active',t.dataset.view==='live'));
renderObservations(observations);
return;
}
fetch('/search?q='+encodeURIComponent(q)+'&limit=50').then(r=>r.json()).then(data=>{
searchResults=data.map(r=>({id:r.id,title:r.title,subtitle:r.subtitle,observation_type:r.observation_type,score:r.score,created_at:new Date().toISOString()}));
currentView='search';
$$('.tab').forEach(t=>t.classList.toggle('active',t.dataset.view==='search'));
renderObservations(searchResults);
}).catch(()=>{});
}

function connectSSE(){
if(eventSource)eventSource.close();
eventSource=new EventSource('/events');
eventSource.onopen=()=>{
$('#statusDot').classList.add('connected');
$('#statusText').textContent='Connected';
};
eventSource.onmessage=(e)=>{
try{
const obs=JSON.parse(e.data);
if(!observations.find(o=>o.id===obs.id)){
observations.unshift(obs);
if(observations.length>200)observations.pop();
if(currentView==='live')renderObservations(observations,true);
updateStats();
}
}catch(err){}
};
eventSource.onerror=()=>{
$('#statusDot').classList.remove('connected');
$('#statusText').textContent='Reconnecting...';
setTimeout(connectSSE,3000);
};
}

$('#searchBtn').onclick=()=>search($('#searchInput').value);
$('#searchInput').onkeydown=(e)=>{if(e.key==='Enter')search($('#searchInput').value);};
$('#clearBtn').onclick=()=>{
$('#searchInput').value='';
currentView='live';
$$('.tab').forEach(t=>t.classList.toggle('active',t.dataset.view==='live'));
renderObservations(observations);
};

$$('.tab').forEach(tab=>{
tab.onclick=()=>{
currentView=tab.dataset.view;
$$('.tab').forEach(t=>t.classList.remove('active'));
tab.classList.add('active');
if(currentView==='live')renderObservations(observations);
else if(currentView==='search')renderObservations(searchResults);
else if(currentView==='timeline')loadTimeline();
};
});

function loadTimeline(){
fetch('/timeline?limit=100').then(r=>r.json()).then(data=>{
const list=data.map(r=>({id:r.id,title:r.title,subtitle:r.subtitle,observation_type:r.observation_type,created_at:new Date().toISOString()}));
renderObservations(list);
}).catch(()=>{});
}

updateStats();
loadRecent();
connectSSE();
})();
</script>
</body>
</html>
